# Feature Specification: Miningスキル改善

## Overview

### Problem Statement
Skillsプラグインが全ての鉱石破壊時にドロップ処理を介入しているため、以下の問題が発生：
- ブロックとしてドロップするもの（古代の残骸、シルクタッチ時）にもボーナスが適用され不自然
- プラグインのドロップ処理がバニラと異なり、アイテムが散らばる

また、Miningスキルの恩恵として、ツルハシの耐久度消費軽減が欲しい。

### Goal
- ボーナスドロップをアイテムがドロップする鉱石に限定し、それ以外はバニラの挙動に任せる
- Miningスキルが高いほどツルハシの耐久度消費を軽減する

### Success Criteria
- アイテム（ダイヤモンド、石炭など）がドロップする鉱石のみボーナス適用
- ブロックがドロップする場合（シルクタッチ、古代の残骸）はプラグインが介入しない
- プラグインが介入しない場合、バニラの自然なドロップ挙動が維持される
- Miningスキル100（GM）で耐久度消費が100%軽減される（耐久度減少なし）

## Background

### 現在の問題
現在の実装では全ての鉱石に対して：
1. `event.isDropItems = false` でバニラのドロップを無効化
2. `dropItemNaturally()` で手動ドロップ
3. ボーナスドロップを追加

これにより：
- シルクタッチでも鉱石ブロックが2つになる（不自然）
- 古代の残骸が2つになる（不自然）
- ドロップがバニラと異なる挙動になる

### 解決アプローチ
**アイテムがドロップする場合のみ**プラグインが介入：
- ダイヤモンド鉱石 → ダイヤモンド（アイテム）→ **介入してボーナス適用**
- シルクタッチ → 鉱石ブロック → **介入しない（バニラ任せ）**
- 古代の残骸 → 古代の残骸ブロック → **介入しない（バニラ任せ）**

## Functional Requirements

### FR-1: ドロップ種別の判定
ブロック破壊時、ドロップがアイテムかブロックかを判定する：
- アイテムドロップ: ダイヤモンド、石炭、鉄の原石、銅の原石、金の原石、金塊、ラピスラズリ、レッドストーン、エメラルド、ネザークォーツなど
- ブロックドロップ: 古代の残骸、シルクタッチ使用時の鉱石ブロック

### FR-2: 条件付き介入
- **アイテムドロップの場合**: ボーナス判定を行い、ドロップ処理を実行
- **ブロックドロップの場合**: プラグインは介入せず、バニラの処理に任せる

### FR-3: ボーナス対象

| 鉱石 | 通常ドロップ | ボーナス |
|------|--------------|----------|
| ダイヤモンド鉱石 | ダイヤモンド | ○ |
| 石炭鉱石 | 石炭 | ○ |
| ラピスラズリ鉱石 | ラピスラズリ | ○ |
| レッドストーン鉱石 | レッドストーン | ○ |
| エメラルド鉱石 | エメラルド | ○ |
| 銅鉱石 | 銅の原石 | ○ |
| 鉄鉱石 | 鉄の原石 | ○ |
| 金鉱石 | 金の原石 | ○ |
| ネザー金鉱石 | 金塊 | ○ |
| ネザークォーツ鉱石 | ネザークォーツ | ○ |
| 古代の残骸 | 古代の残骸 | × (バニラ) |
| シルクタッチ使用時 | 鉱石ブロック | × (バニラ) |

### FR-4: ツルハシ耐久度消費軽減
Miningスキルに応じて、鉱石採掘時のツルハシ耐久度消費を確率で無効化する：

**計算式**:
```
耐久度消費キャンセル確率 = Miningスキル × 0.9 (%)
※ GM（スキル100）の場合は100%
```

| Miningスキル | キャンセル確率 |
|-------------|---------------|
| 0 | 0% |
| 20 | 18% |
| 50 | 45% |
| 80 | 72% |
| 90 | 81% |
| 99 | 89% |
| 100 (GM) | 100% |

**適用条件**:
- プレイヤーがツルハシを使用している
- 鉱石ブロック（`GatheringDifficulty.isOre()`がtrue）を破壊した

## User Scenarios & Testing

### Scenario 1: ダイヤモンド鉱石採掘
**Given**: プレイヤーがダイヤモンド鉱石を採掘する
**When**: ブロックが破壊される
**Then**: ダイヤモンドがドロップし、スキルに応じてボーナスが適用される

### Scenario 2: シルクタッチで採掘
**Given**: プレイヤーがシルクタッチ付きツルハシでダイヤモンド鉱石を採掘する
**When**: ブロックが破壊される
**Then**: ダイヤモンド鉱石ブロックが1つだけ落ちる（バニラ挙動）

### Scenario 3: 古代の残骸採掘
**Given**: プレイヤーが古代の残骸を採掘する
**When**: ブロックが破壊される
**Then**: 古代の残骸が1つだけ落ちる（バニラ挙動）

### Scenario 4: 石炭鉱石採掘（ボーナス発動）
**Given**: プレイヤーがMiningスキル100で石炭鉱石を採掘する
**When**: ボーナス判定に成功する
**Then**: 石炭が2つ落ちる

### Scenario 5: ツルハシ耐久度軽減（GM）
**Given**: プレイヤーがMiningスキル100（GM）でダイヤモンド鉱石を採掘する
**When**: 鉱石を採掘する
**Then**: ツルハシの耐久度は一切消費されない（100%軽減）

### Scenario 5b: ツルハシ耐久度軽減（非GM）
**Given**: プレイヤーがMiningスキル50でダイヤモンド鉱石を採掘する
**When**: 100回採掘する
**Then**: ツルハシの耐久度消費は約55回分（45%軽減）

### Scenario 6: 耐久度軽減は鉱石のみ
**Given**: プレイヤーがMiningスキル100で石（鉱石ではない）を採掘する
**When**: ブロックが破壊される
**Then**: ツルハシの耐久度は通常通り消費される

## Scope

### In Scope
- Miningスキルのボーナスドロップ対象の制限
- アイテム/ブロックドロップの判定ロジック
- Miningスキルによるツルハシ耐久度消費軽減

### Out of Scope
- Lumberjacking（原木→原木のボーナスは維持）
- Farming（作物のボーナスは維持）
- ドロップ物理の修正（バニラ任せで解決）
- 斧やクワなど他のツールの耐久度軽減

## Assumptions
- `Material.isBlock()` でドロップがブロックかアイテムかを判定できる
- シルクタッチ使用時は `getDrops()` が鉱石ブロックを返す
- プラグインが介入しなければバニラのドロップ処理が実行される
- `PlayerItemDamageEvent` でツルハシの耐久度消費をキャンセルできる

## Dependencies
- 既存のGatheringListener.kt
- 既存のGatheringManager.kt
- Bukkit Material API
- PlayerItemDamageEvent
